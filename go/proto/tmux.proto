syntax = "proto3";

package mcp.tmux.v1;

option go_package = "github.com/k8ika0s/mcp-tmux/go/proto;tmuxproto";

message PaneRef {
  string host = 1;   // ssh alias or empty for local
  string session = 2;
  string window = 3;
  string pane = 4;   // tmux pane id (optional if default)
}

message StreamPaneRequest {
  PaneRef target = 1;
  uint64 from_seq = 2;
  bool strip_ansi = 3;
  uint32 max_chunk_bytes = 4;
  uint32 poll_millis = 5;      // optional: override poll interval (defaults to 1000ms)
}

message PaneChunk {
  PaneRef target = 1;
  uint64 seq = 2;
  int64 ts_unix_millis = 3;
  bytes data = 4;
  bool is_truncated = 5;
  bool heartbeat = 6;
  bool eof = 7;
  string reason = 8;
}

message SnapshotRequest {
  PaneRef target = 1;
  uint32 capture_lines = 2;
}

message SnapshotResponse {
  string sessions = 1;
  string windows = 2;
  string panes = 3;
  string capture = 4;
}

message ListRequest { PaneRef target = 1; }
message ListResponse { string text = 1; }

message SetDefaultRequest { PaneRef target = 1; }
message SetDefaultResponse { string text = 1; }

message CapturePaneRequest {
  PaneRef target = 1;
  int32 lines = 2;        // negative or zero -> default tail
  bool strip_ansi = 3;
  int32 start = 4;        // optional start offset (negative from bottom)
}

message CapturePaneResponse {
  PaneRef target = 1;
  string text = 2;
  bool truncated = 3;
}

message BatchCaptureRequest {
  repeated CapturePaneRequest requests = 1;
}

message BatchCaptureResponse {
  repeated CapturePaneResponse captures = 1;
}

message RunCommandRequest {
  PaneRef target = 1;
  repeated string args = 2;
  bool strip_ansi = 3;
  bool confirm = 4;            // required for destructive commands
}

message RunCommandResponse { string text = 1; }

message SendKeysRequest {
  PaneRef target = 1;
  repeated string keys = 2;
  bool enter = 3;
}

message SendKeysResponse { string text = 1; }

message RunBatchRequest {
  PaneRef target = 1;
  repeated string steps = 2;   // shell fragments to join
  string join_with = 3;        // default "&&"
  bool clean_prompt = 4;       // send C-c/C-u before running
  bool strip_ansi = 5;
  int32 capture_lines = 6;     // optional capture after run (0 = skip)
}

message RunBatchResponse {
  string text = 1;             // status message
  string capture = 2;          // optional capture text
  bool truncated = 3;
}

message MultiRunRequest {
  repeated MultiRunStep steps = 1;
  bool strip_ansi = 2;
}

message MultiRunStep {
  PaneRef target = 1;
  repeated string args = 2;
}

message MultiRunResult {
  PaneRef target = 1;
  string text = 2;
  string error = 3;
}

message MultiRunResponse {
  repeated MultiRunResult results = 1;
}

message CaptureLayoutRequest { PaneRef target = 1; }

message WindowLayout {
  string window = 1;
  string layout = 2;
}

message CaptureLayoutResponse {
  repeated WindowLayout layouts = 1;
}

message RestoreLayoutRequest {
  PaneRef target = 1;
  repeated WindowLayout layouts = 2;
}

message RestoreLayoutResponse { string text = 1; }

message NewSessionRequest {
  PaneRef target = 1;          // session and host used; window/pane ignored
  bool attach = 2;             // attach after create
  string command = 3;          // optional command to run in session
}

message NewSessionResponse { string text = 1; }

message NewWindowRequest {
  PaneRef target = 1;          // requires session
  string name = 2;
  string command = 3;
}

message NewWindowResponse { string text = 1; }

message ServerInfoRequest {}

message ServerInfoResponse {
  string package_name = 1;
  string version = 2;
  string repo_url = 3;
}

service TmuxService {
  rpc StreamPane(StreamPaneRequest) returns (stream PaneChunk);
  rpc Snapshot(SnapshotRequest) returns (SnapshotResponse);
  rpc CapturePane(CapturePaneRequest) returns (CapturePaneResponse);
  rpc RunCommand(RunCommandRequest) returns (RunCommandResponse);
  rpc SendKeys(SendKeysRequest) returns (SendKeysResponse);
  rpc RunBatch(RunBatchRequest) returns (RunBatchResponse);
  rpc MultiRun(MultiRunRequest) returns (MultiRunResponse);
  rpc BatchCapture(BatchCaptureRequest) returns (BatchCaptureResponse);
  rpc CaptureLayout(CaptureLayoutRequest) returns (CaptureLayoutResponse);
  rpc RestoreLayout(RestoreLayoutRequest) returns (RestoreLayoutResponse);
  rpc NewSession(NewSessionRequest) returns (NewSessionResponse);
  rpc NewWindow(NewWindowRequest) returns (NewWindowResponse);
  rpc ServerInfo(ServerInfoRequest) returns (ServerInfoResponse);
  rpc ListSessions(ListRequest) returns (ListResponse);
  rpc ListWindows(ListRequest) returns (ListResponse);
  rpc ListPanes(ListRequest) returns (ListResponse);
  rpc SetDefault(SetDefaultRequest) returns (SetDefaultResponse);
}
